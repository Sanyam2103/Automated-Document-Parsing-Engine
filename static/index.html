<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GSA Document Analyzer - Complete Interface</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f7fa; }
        
        .header { background: #1e40af; color: white; padding: 20px; text-align: center; }
        .header h1 { margin-bottom: 5px; }
        .status-bar { background: #374151; color: #e5e7eb; padding: 10px; font-size: 14px; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .panel h2 { margin-bottom: 15px; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        
        /* Forms */
        select, textarea, input { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin: 5px 0; }
        textarea { height: 80px; font-family: 'Courier New', monospace; resize: vertical; }
        label { display: block; font-weight: 500; margin: 10px 0 5px; color: #374151; }
        
        .doc-input { border: 1px solid #e5e7eb; padding: 15px; margin: 10px 0; border-radius: 6px; background: #f9fafb; }
        .remove-btn { background: #ef4444; color: white; width: auto; padding: 5px 10px; margin-top: 5px; }
        
        /* Results */
        .result-section { margin: 15px 0; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; }
        .result-header { background: #f8fafc; padding: 12px; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        .result-content { padding: 15px; max-height: 400px; overflow-y: auto; }
        
        .status { display: inline-block; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .status.ok { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.unknown { background: #f3f4f6; color: #6b7280; }
        
        .field { display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 8px; background: #f9fafb; margin: 5px 0; border-radius: 4px; }
        .field-label { font-weight: 600; color: #4b5563; }
        
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .spinner { border: 2px solid #f3f4f6; border-top: 2px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .code { background: #f1f5f9; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; white-space: pre-wrap; }
        
        /* Enhanced text content formatting */
        .text-content { 
            background: #f8fafc; 
            padding: 20px; 
            border-radius: 8px; 
            line-height: 1.7; 
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        
        .email-content {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .email-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .brief-content {
            background: #fefefe;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            font-family: Georgia, serif;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 15px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #3b82f6; background: #eff6ff; }
        
        .full-width { grid-column: 1 / -1; }
        
        /* Redacted data styling */
        .redacted-section { background: #fef3c7; padding: 10px; border-radius: 4px; margin: 5px 0; border-left: 3px solid #f59e0b; }
        .pii-hash { font-family: monospace; color: #6b7280; font-size: 11px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è GSA Document Analyzer</h1>
        <p>Complete Backend Interface - All Endpoints</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        System Status: <span id="system-status">Unknown</span> | Request ID: <span id="current-request">None</span>
    </div>
    
    <div class="container">
        <!-- Main Controls -->
        <div class="controls">
            <button class="btn btn-success" onclick="checkHealth()">üè• Health Check</button>
            <button class="btn btn-warning" onclick="testServices()">üß™ Test AI Services</button>
            <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>
        
        <div class="grid">
            <!-- Document Input Panel -->
            <div class="panel">
                <h2>üì• Document Input</h2>
                
                <label>Quick Samples:</label>
                <select id="sample-select" onchange="loadSample()">
                    <option value="">-- Load Sample --</option>
                    <option value="complete">‚úÖ Complete Vendor</option>
                    <option value="incomplete">‚ùå Incomplete Vendor</option>
                    <option value="custom">‚úèÔ∏è Custom Data</option>
                </select>
                
                <div id="documents-container">
                    <!-- Dynamic document inputs will be added here -->
                </div>
                
                <div style="margin: 15px 0;">
                    <button class="btn btn-success" onclick="addDocument()" style="width: auto;">+ Add Document</button>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="ingestDocuments()" id="ingest-btn">üì§ Ingest Documents</button>
                    <button class="btn btn-secondary" onclick="analyzeDocuments()" id="analyze-btn" disabled>üîç Analyze</button>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="panel">
                <h2>üìä Analysis Results</h2>
                <div id="results-content">
                    <div class="loading">No analysis results yet. Ingest documents first.</div>
                </div>
            </div>
            
            <!-- Debug Panel -->
            <div class="panel full-width">
                <h2>üõ†Ô∏è System Debug & Testing</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="showTab('debug-data')">Debug Data</div>
                    <div class="tab" onclick="showTab('health-info')">Health Info</div>
                    <div class="tab" onclick="showTab('service-test')">Service Tests</div>
                    <div class="tab" onclick="showTab('raw-response')">Raw Response</div>
                </div>
                
                <div id="debug-data" class="tab-content">
                    <div class="controls">
                        <input type="text" id="debug-request-id" placeholder="Request ID (leave empty for current)">
                        <button class="btn btn-warning" onclick="debugRequest()">üêõ Debug Request</button>
                    </div>
                    <div id="debug-results">No debug data loaded.</div>
                </div>
                
                <div id="health-info" class="tab-content" style="display: none;">
                    <div id="health-results">Click "Health Check" to test system status.</div>
                </div>
                
                <div id="service-test" class="tab-content" style="display: none;">
                    <div id="service-results">Click "Test AI Services" to check RAG and LLM availability.</div>
                </div>
                
                <div id="raw-response" class="tab-content" style="display: none;">
                    <div id="raw-results">Raw API responses will appear here after operations.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRequestId = null;
        let lastRawResponse = null;
        
        // Sample data
        const samples = {
            complete: [
                {
                    name: "company_profile",
                    type: "profile", 
                    text: "TechCorp LLC UEI: ABC123DEF456 DUNS: 123456789 NAICS: 541511 POC: John Smith, john@techcorp.com, (555) 123-4567 Address: 123 Main St, Washington DC 20500 SAM.gov: registered"
                },
                {
                    name: "past_performance",
                    type: "past_performance",
                    text: "Customer: Department of Defense Contract: Software development Value: $150,000 Period: 01/2023 - 12/2023 Contact: procurement@dod.mil"
                },
                {
                    name: "pricing_sheet", 
                    type: "pricing",
                    text: "Senior Developer, 185, Hour\nSystems Architect, 225, Hour\nProject Manager, 175, Hour"
                }
            ],
            incomplete: [
                {
                    name: "broken_company",
                    type: "profile",
                    text: "Incomplete Corp Contact: jane@incomplete.com"
                }
            ],
            custom: [
                {
                    name: "custom_doc",
                    type: "",
                    text: "Enter your custom document content here..."
                }
            ]
        };
        
        // Initialize with one document input
        document.addEventListener('DOMContentLoaded', function() {
            addDocument();
            updateStatus('Ready');
        });
        
        function loadSample() {
            const selected = document.getElementById('sample-select').value;
            if (!selected) return;
            
            const container = document.getElementById('documents-container');
            container.innerHTML = '';
            
            samples[selected].forEach(doc => {
                addDocument();
                const lastInput = container.lastElementChild;
                lastInput.querySelector('.doc-name').value = doc.name;
                lastInput.querySelector('.doc-type').value = doc.type;
                lastInput.querySelector('.doc-text').value = doc.text;
            });
        }
        
        function addDocument() {
            const container = document.getElementById('documents-container');
            const index = container.children.length + 1;
            
            const docDiv = document.createElement('div');
            docDiv.className = 'doc-input';
            docDiv.innerHTML = `
                <label>Document Name:</label>
                <input type="text" class="doc-name" placeholder="document_${index}" value="document_${index}">
                
                <label>Type Hint:</label>
                <select class="doc-type">
                    <option value="">Auto-detect</option>
                    <option value="profile">Company Profile</option>
                    <option value="past_performance">Past Performance</option>
                    <option value="pricing">Pricing Sheet</option>
                </select>
                
                <label>Document Text:</label>
                <textarea class="doc-text" placeholder="Paste document content here..."></textarea>
                
                <button class="remove-btn" onclick="removeDocument(this)">Remove</button>
            `;
            container.appendChild(docDiv);
        }
        
        function removeDocument(btn) {
            btn.parentElement.remove();
        }
        
        async function ingestDocuments() {
            const documents = [];
            const docInputs = document.querySelectorAll('.doc-input');
            
            docInputs.forEach(input => {
                const name = input.querySelector('.doc-name').value.trim();
                const type = input.querySelector('.doc-type').value;
                const text = input.querySelector('.doc-text').value.trim();
                
                if (text) {
                    documents.push({
                        name: name || `document_${documents.length + 1}`,
                        type_hint: type || null,
                        text: text
                    });
                }
            });
            
            if (documents.length === 0) {
                alert('Please add at least one document with content.');
                return;
            }
            
            updateStatus('Ingesting documents...');
            showLoading('results-content', 'Processing documents...');
            
            try {
                const response = await fetch('/api/ingest_v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documents })
                });
                
                const result = await response.json();
                lastRawResponse = result;
                
                if (result.request_id) {
                    currentRequestId = result.request_id;
                    document.getElementById('current-request').textContent = currentRequestId;
                    document.getElementById('analyze-btn').disabled = false;
                    
                    showIngestResults(result);
                    updateStatus('Documents ingested - Ready for analysis');
                } else {
                    throw new Error('No request ID received');
                }
                
            } catch (error) {
                showError('results-content', `Ingestion failed: ${error.message}`);
                updateStatus('Ingestion failed');
            }
        }
        
        async function analyzeDocuments() {
            if (!currentRequestId) {
                alert('Please ingest documents first.');
                return;
            }
            
            updateStatus('Running AI analysis...');
            showLoading('results-content', 'Analyzing compliance...');
            
            try {
                const response = await fetch(`/api/analyze?request_id=${currentRequestId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                lastRawResponse = result;
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                showAnalysisResults(result);
                updateStatus('Analysis complete');
                
            } catch (error) {
                showError('results-content', `Analysis failed: ${error.message}`);
                updateStatus('Analysis failed');
            }
        }
        
        async function checkHealth() {
            updateStatus('Checking system health...');
            
            try {
                const response = await fetch('/api/healthz');
                const result = await response.json();
                
                const healthDiv = document.getElementById('health-results');
                healthDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">üè• System Health Check</div>
                        <div class="result-content">
                            <div class="field">
                                <div class="field-label">Status:</div>
                                <div><span class="status ${result.status === 'healthy' ? 'ok' : 'error'}">${result.status?.toUpperCase() || 'UNKNOWN'}</span></div>
                            </div>
                            <div class="field">
                                <div class="field-label">Version:</div>
                                <div>${result.version || 'Unknown'}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">Timestamp:</div>
                                <div>${result.timestamp ? new Date(result.timestamp * 1000).toLocaleString() : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                updateStatus(result.status === 'healthy' ? 'System healthy' : 'System unhealthy');
                
            } catch (error) {
                const healthDiv = document.getElementById('health-results');
                healthDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">‚ùå Health Check Failed</div>
                        <div class="result-content">
                            <span class="status error">UNHEALTHY</span>
                            <p>Error: ${error.message}</p>
                        </div>
                    </div>
                `;
                updateStatus('System unhealthy');
            }
        }
        
        async function testServices() {
            updateStatus('Testing AI services...');
            
            try {
                const response = await fetch('/api/test-services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                const serviceDiv = document.getElementById('service-results');
                serviceDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">üß™ AI Services Test Results</div>
                        <div class="result-content">
                            <div class="field">
                                <div class="field-label">Overall Status:</div>
                                <div><span class="status ${result.overall_status === 'all_services_ready' ? 'ok' : 'error'}">${result.overall_status?.replace(/_/g, ' ').toUpperCase() || 'UNKNOWN'}</span></div>
                            </div>
                            <div class="field">
                                <div class="field-label">Validator:</div>
                                <div><span class="status ${result.validator?.status === 'available' ? 'ok' : 'error'}">${result.validator?.status?.toUpperCase() || 'UNKNOWN'}</span></div>
                            </div>
                            <div class="field">
                                <div class="field-label">RAG Service:</div>
                                <div><span class="status ${result.rag?.status === 'available' ? 'ok' : 'error'}">${result.rag?.status?.toUpperCase() || 'UNKNOWN'}</span></div>
                            </div>
                            <div class="field">
                                <div class="field-label">LLM Service:</div>
                                <div><span class="status ${result.llm?.status === 'available' ? 'ok' : 'error'}">${result.llm?.status?.toUpperCase() || 'UNKNOWN'}</span></div>
                            </div>
                            ${result.llm?.connection_test ? `
                                <div class="field">
                                    <div class="field-label">LLM Connection:</div>
                                    <div><span class="status ${result.llm.connection_test.status === 'success' ? 'ok' : 'error'}">${result.llm.connection_test.status?.toUpperCase()}</span></div>
                                </div>
                            ` : ''}
                            <details style="margin-top: 15px;">
                                <summary>Full Test Results</summary>
                                <div class="code">${JSON.stringify(result, null, 2)}</div>
                            </details>
                        </div>
                    </div>
                `;
                
                updateStatus('Service test complete');
                
            } catch (error) {
                showError('service-results', `Service test failed: ${error.message}`);
                updateStatus('Service test failed');
            }
        }
        
        async function debugRequest() {
            const requestId = document.getElementById('debug-request-id').value.trim() || currentRequestId;
            
            if (!requestId) {
                alert('Please provide a request ID or ingest documents first.');
                return;
            }
            
            updateStatus('Loading debug data...');
            
            try {
                const response = await fetch(`/api/debug/${requestId}`);
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const debugDiv = document.getElementById('debug-results');
                debugDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">üêõ Debug Data for ${requestId}</div>
                        <div class="result-content">
                            <div class="field">
                                <div class="field-label">Request ID:</div>
                                <div>${result.request_id}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">Documents:</div>
                                <div>${result.document_count || 0}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">Status:</div>
                                <div>${result.status || 'Unknown'}</div>
                            </div>
                            ${result.redacted_docs ? renderDebugRedactedData(result.redacted_docs) : ''}
                            <details style="margin-top: 15px;">
                                <summary>Parsed Data Structure</summary>
                                <div class="code">${JSON.stringify(result.parsed_data || {}, null, 2)}</div>
                            </details>
                        </div>
                    </div>
                `;
                
                updateStatus('Debug data loaded');
                
            } catch (error) {
                showError('debug-results', `Debug failed: ${error.message}`);
                updateStatus('Debug failed');
            }
        }
        
        function renderDebugRedactedData(redacted_docs) {
    if (!redacted_docs) {
        return '<p>No redacted documents found.</p>';
    }
    
    let html = '<h4>Document Processing Results:</h4>';
    
    // Handle array format
    if (Array.isArray(redacted_docs)) {
        redacted_docs.forEach((doc, i) => {
            html += `
                <div class="redacted-section" style="margin: 10px 0;">
                    <strong>Document ${i + 1}: ${doc.name || 'Unnamed'}</strong><br>
                    <div class="field">
                        <div class="field-label">Type:</div>
                        <div>${doc.type || 'Unknown'}</div>
                    </div>
                    ${doc.error ? `
                        <div class="field">
                            <div class="field-label">Error:</div>
                            <div style="color: #dc2626;">${doc.error}</div>
                        </div>
                    ` : ''}
                    ${doc.pii_hashes ? `
                        <div class="pii-hash">PII Hashes: ${Object.keys(doc.pii_hashes).length} items protected</div>
                    ` : ''}
                    ${doc.redacted_text ? `
                        <details>
                            <summary>Redacted Content</summary>
                            <div class="code" style="max-height: 150px; overflow-y: auto;">${doc.redacted_text}</div>
                        </details>
                    ` : ''}
                </div>
            `;
        });
    }
    // Handle object format
    else {
        ['company', 'past_performance', 'pricing'].forEach(type => {
            if (redacted_docs[type]) {
                html += `<h5>${type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}:</h5>`;
                
                if (Array.isArray(redacted_docs[type])) {
                    redacted_docs[type].forEach((item, i) => {
                        html += `
                            <div class="redacted-section">
                                <strong>${type} ${i + 1}:</strong><br>
                                ${item.redacted_text ? `<div class="code">${item.redacted_text}</div>` : ''}
                                ${item.pii_hashes ? `<div class="pii-hash">PII: ${Object.keys(item.pii_hashes).length} items</div>` : ''}
                            </div>
                        `;
                    });
                } else {
                    const item = redacted_docs[type];
                    html += `
                        <div class="redacted-section">
                            ${item.redacted_text ? `<div class="code">${item.redacted_text}</div>` : ''}
                            ${item.pii_hashes ? `<div class="pii-hash">PII: ${Object.keys(item.pii_hashes).length} items</div>` : ''}
                        </div>
                    `;
                }
            }
        });
    }
    
    return html;
}

        
        function showIngestResults(result) {
            const html = `
                <div class="result-section">
                    <div class="result-header">‚úÖ Documents Ingested</div>
                    <div class="result-content">
                        <div class="field">
                            <div class="field-label">Request ID:</div>
                            <div>${result.request_id}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Documents Processed:</div>
                            <div>${result.doc_summaries?.length || 0}</div>
                        </div>
                        
                        ${result.doc_summaries ? `
                            <h4>Document Summary:</h4>
                            ${result.doc_summaries.map(doc => `
                                <div class="field">
                                    <div class="field-label">${doc.name}:</div>
                                    <div>${doc.type} ${doc.error ? `<span style="color: #dc2626;">(Error: ${doc.error})</span>` : doc.redacted ? '(PII Redacted)' : '(Not Redacted)'}</div>
                                </div>
                            `).join('')}
                        ` : ''}
                        
                        ${result.processing_stats ? `
                            <h4>Processing Stats:</h4>
                            <div class="field">
                                <div class="field-label">Total:</div>
                                <div>${result.processing_stats.total_documents}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">Successful:</div>
                                <div>${result.processing_stats.successfully_processed}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">PII Redaction:</div>
                                <div>${result.processing_stats.pii_redaction_applied ? 'Applied' : 'Not Applied'}</div>
                            </div>
                        ` : ''}
                        
                        <div style="color: #10b981; margin-top: 15px; font-weight: 600;">
                            ‚úÖ Ready for analysis! Click "Analyze" button.
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('results-content').innerHTML = html;
        }
        
        function showAnalysisResults(result) {
            const checklist = result.checklist || {};
            const parsed = result.parsed || {};
            
            let html = `
                <div class="result-section">
                    <div class="result-header">üéØ Compliance Status</div>
                    <div class="result-content">
                        <span class="status ${checklist.required_ok ? 'ok' : 'error'}">
                            ${checklist.required_ok ? '‚úÖ COMPLIANT' : '‚ùå NON-COMPLIANT'}
                        </span>
                        ${checklist.compliance_summary ? `<p style="margin-top: 10px;">${checklist.compliance_summary}</p>` : ''}
                        ${checklist.issue_breakdown ? `
                            <div style="margin-top: 10px;">
                                <strong>Issue Breakdown:</strong>
                                Blocking: ${checklist.issue_breakdown.blocking || 0}, 
                                Critical: ${checklist.issue_breakdown.critical || 0}, 
                                Minor: ${checklist.issue_breakdown.minor || 0}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Issues Section
            if (checklist.problems && checklist.problems.length > 0) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üö® Issues Found (${checklist.problems.length})</div>
                        <div class="result-content">
                            ${checklist.problems.map(problem => `
                                <div style="background: #fef2f2; border-left: 4px solid #f87171; padding: 12px; margin: 10px 0; border-radius: 4px;">
                                    <strong>${(problem.issue || problem.description || 'Issue').replace(/_/g, ' ').toUpperCase()}</strong>
                                    ${problem.rule_id ? `<span style="background: #1d4ed8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 10px;">${problem.rule_id}</span>` : ''}
                                    <br><br>
                                    <span style="color: #6b7280;">Evidence:</span> ${problem.evidence || problem.description || 'No details available'}
                                    ${problem.severity ? `<br><span style="color: #6b7280;">Severity:</span> <span style="color: ${problem.severity === 'blocking' ? '#dc2626' : problem.severity === 'critical' ? '#ea580c' : '#65a30d'}; font-weight: 600;">${problem.severity.toUpperCase()}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Parsed Data Section
            html += `
                <div class="result-section">
                    <div class="result-header">üìã Parsed Data</div>
                    <div class="result-content">
                        ${renderParsedData(parsed)}
                    </div>
                </div>
            `;
            
            // Citations Section
            if (checklist.citations && checklist.citations.length > 0) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìö Rule Citations (${checklist.citations.length})</div>
                        <div class="result-content">
                            ${checklist.citations.map(citation => `
                                <div style="background: #eff6ff; padding: 12px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #3b82f6;">
                                    <strong style="color: #1d4ed8;">${citation.rule_id}:</strong><br>
                                    <span style="color: #4b5563;">${citation.chunk || citation.content || 'No content available'}</span>
                                    ${citation.addressing_issues && citation.addressing_issues.length > 0 ? `<br><small style="color: #6b7280;">Addresses: ${citation.addressing_issues.join(', ')}</small>` : ''}
                                    ${citation.source ? `<br><small style="color: #6b7280;">Source: ${citation.source}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Strategic Brief Section with enhanced formatting
            if (result.brief) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìù Strategic Negotiation Brief</div>
                        <div class="result-content">
                            <div class="brief-content">${formatBriefContent(result.brief)}</div>
                        </div>
                    </div>
                `;
            }
            
            // Client Email Section with enhanced formatting
            if (result.client_email) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìß Client Communication</div>
                        <div class="result-content">
                            <div class="email-content">${formatEmailContent(result.client_email)}</div>
                        </div>
                    </div>
                `;
            }
            
            // Analysis Statistics
            if (result.analysis_stats) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìä Analysis Statistics</div>
                        <div class="result-content">
                            <div class="field">
                                <div class="field-label">Method:</div>
                                <div>${result.analysis_stats.method || result.analysis_stats.analysis_method || 'Unknown'}</div>
                            </div>
                            ${result.analysis_stats.total_issues !== undefined ? `
                                <div class="field">
                                    <div class="field-label">Total Issues:</div>
                                    <div>${result.analysis_stats.total_issues}</div>
                                </div>
                            ` : ''}
                            ${result.analysis_stats.rules_retrieved !== undefined ? `
                                <div class="field">
                                    <div class="field-label">Rules Retrieved:</div>
                                    <div>${result.analysis_stats.rules_retrieved}</div>
                                </div>
                            ` : ''}
                            ${result.analysis_stats.total_time ? `
                                <div class="field">
                                    <div class="field-label">Total Time:</div>
                                    <div>${result.analysis_stats.total_time.toFixed(3)}s</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Metadata Section
            html += `
                <div class="result-section">
                    <div class="result-header">‚ÑπÔ∏è Analysis Metadata</div>
                    <div class="result-content">
                        <div class="field">
                            <div class="field-label">Request ID:</div>
                            <div>${result.request_id || 'Unknown'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Timestamp:</div>
                            <div>${result.timestamp || new Date().toLocaleString()}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Powered By:</div>
                            <div>${result.powered_by || 'Unknown'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = html;
            
            // Update raw response tab
            document.getElementById('raw-results').innerHTML = `
                <div class="result-section">
                    <div class="result-header">üìã Latest API Response</div>
                    <div class="result-content">
                        <div class="code">${JSON.stringify(result, null, 2)}</div>
                    </div>
                </div>
            `;
        }
        
        function renderParsedData(parsed) {
            if (!parsed || Object.keys(parsed).length === 0) {
                return '<p style="color: #6b7280;">No parsed data available</p>';
            }

            // If parsed is a redacted_docs object (from backend), render its structure
            if (
                typeof parsed === "object" &&
                (
                    parsed.company ||
                    (parsed.past_performance && Array.isArray(parsed.past_performance)) ||
                    parsed.pricing
                )
            ) {
                // Show pretty JSON for the entire parsed object
                return `<pre class="code" style="white-space: pre-wrap; background: #f1f5f9; border-radius: 6px; font-size: 13px; max-height: 400px; overflow-y: auto;">${JSON.stringify(parsed, null, 2)}</pre>`;
            }

            // Handle standard parsed data structure (fallback)
            else {
                // Company Information
                if (parsed.company) {
                    html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üè¢ Company Information</h4>';
                    html += '<div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px;">';
                    
                    Object.entries(parsed.company).forEach(([key, value]) => {
                        if (value != null && key !== '_metadata' && value !== '') {
                            const displayValue = Array.isArray(value) ? value.join(', ') : String(value);
                            html += `
                                <div class="field">
                                    <div class="field-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</div>
                                    <div>${displayValue}</div>
                                </div>
                            `;
                        }
                    });
                    html += '</div>';
                }
                
                // Past Performance
                if (parsed.past_performance && parsed.past_performance.length > 0) {
                    html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üìà Past Performance</h4>';
                    
                    parsed.past_performance.forEach((pp, i) => {
                        html += `<div style="background: #f0f9ff; border: 1px solid #e0f2fe; padding: 12px; margin: 8px 0; border-radius: 6px;">`;
                        html += `<strong style="color: #0369a1;">Contract ${i + 1}:</strong><br>`;
                        
                        Object.entries(pp).forEach(([key, value]) => {
                            if (value != null && value !== '') {
                                html += `
                                    <div class="field">
                                        <div class="field-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</div>
                                        <div>${value}</div>
                                    </div>
                                `;
                            }
                        });
                        html += '</div>';
                    });
                }
                
                // Pricing Information
                if (parsed.pricing) {
                    html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üí∞ Pricing Information</h4>';
                    html += '<div style="background: #f0fdf4; padding: 12px; border-radius: 6px; margin-bottom: 15px;">';
                    
                    if (parsed.pricing.labor_categories && parsed.pricing.labor_categories.length > 0) {
                        html += '<h5 style="margin-bottom: 8px;">Labor Categories:</h5>';
                        parsed.pricing.labor_categories.forEach((cat, i) => {
                            html += `
                                <div style="background: white; border: 1px solid #d1d5db; padding: 8px; margin: 5px 0; border-radius: 4px;">
                                    <div class="field">
                                        <div class="field-label">Category:</div>
                                        <div>${cat.category || `Category ${i + 1}`}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Rate:</div>
                                        <div>$${cat.rate || 'N/A'}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Unit:</div>
                                        <div>${cat.unit || 'N/A'}</div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #6b7280;">No labor categories found</p>';
                    }
                    html += '</div>';
                }
            }
            
            // Show any additional fields not covered above
            const excludeKeys = ['company', 'past_performance', 'pricing', 'redacted_docs', '_metadata'];
            const otherFields = Object.entries(parsed).filter(([key]) => !excludeKeys.includes(key));
            
            if (otherFields.length > 0) {
                html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üìÑ Additional Fields</h4>';
                html += '<div style="background: #faf5ff; padding: 12px; border-radius: 6px;">';
                
                otherFields.forEach(([key, value]) => {
                    if (value != null) {
                        html += `
                            <div class="field">
                                <div class="field-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</div>
                                <div>${typeof value === 'object' ? JSON.stringify(value, null, 2) : value}</div>
                            </div>
                        `;
                    }
                });
                html += '</div>';
            }
            
            return html || '<p style="color: #6b7280;">No structured data found</p>';
        }

        
        function formatBriefContent(brief) {
            if (!brief) return 'No brief available';
            
            // Format the brief with better paragraph breaks and emphasis
            return brief
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold markdown
                .replace(/\n\n/g, '</p><p style="margin-bottom: 15px;">') // Paragraph breaks
                .replace(/\n/g, '<br>') // Line breaks
                .replace(/^/, '<p style="margin-bottom: 15px;">') // Start paragraph
                .replace(/$/, '</p>'); // End paragraph
        }
        
        function formatEmailContent(email) {
    if (!email) return 'No email available';
    
    // Clean and process the email text
    const cleanEmail = email.trim();
    
    // Split into lines for processing
    const lines = cleanEmail.split('\n');
    
    let subject = '';
    let sender = '';
    let date = '';
    let body = '';
    let isBodySection = false;
    
    // Parse email headers and body
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.toLowerCase().startsWith('subject:')) {
            subject = line.substring(8).trim();
        }
        else if (line.toLowerCase().startsWith('from:')) {
            sender = line.substring(5).trim();
        }
        else if (line.toLowerCase().startsWith('date:')) {
            date = line.substring(5).trim();
        }
        else if (line.toLowerCase().startsWith('to:')) {
            // Skip To: line, we'll handle it in body
        }
        else if (line === '' && !isBodySection && (subject || i > 2)) {
            isBodySection = true;
        }
        else if (isBodySection || (!subject && !line.includes(':'))) {
            body += line + '\n';
            isBodySection = true;
        }
        else if (!isBodySection) {
            body += line + '\n';
        }
    }
    
    // Build formatted email
    let formattedEmail = '';
    
    // Email headers section
    if (subject || sender || date) {
        formattedEmail += '<div class="email-header">';
        
        if (subject) {
            formattedEmail += `<div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">üìß ${subject}</div>`;
        }
        
        if (sender) {
            formattedEmail += `<div style="color: #6b7280; margin-bottom: 4px;"><strong>From:</strong> ${sender}</div>`;
        }
        
        if (date) {
            formattedEmail += `<div style="color: #6b7280; margin-bottom: 4px;"><strong>Date:</strong> ${date}</div>`;
        }
        
        formattedEmail += '</div>';
    }
    
    // Email body section
    const bodyContent = body.trim();
    if (bodyContent) {
        // Process body formatting
        let formattedBody = bodyContent
            // Markdown bold (**text**)
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle greeting
            .replace(/(Dear [^,\n]+,?)/gi, '<div style="margin-bottom: 15px; font-weight: 600;">$1</div>')
            // Handle sign-off
            .replace(/(Best regards,|Sincerely,|Thank you,|Regards,)\s*\n/gi, '<div style="margin-top: 20px; margin-bottom: 5px;">$1</div>')
            // Handle bullet points
            .replace(/^[\s]*[‚Ä¢\-\*]\s*/gm, '‚Ä¢ ')
            .replace(/^‚Ä¢ /gm, '<div style="margin: 5px 0; padding-left: 15px;">‚Ä¢ ')
            .replace(/\n(?=‚Ä¢ )/g, '</div>\n')
            // Handle numbered lists
            .replace(/^\s*\d+\.\s+/gm, (match) => `<div style="margin: 5px 0; padding-left: 15px;">${match}`)
            // Handle paragraphs
            .replace(/\n\s*\n/g, '</p><p style="margin: 12px 0; line-height: 1.6;">')
            // Handle single line breaks
            .replace(/\n/g, '<br>')
            // Wrap in paragraph tags
            .replace(/^/, '<p style="margin: 12px 0; line-height: 1.6;">')
            .replace(/$/, '</p>');
        
        // Close any unclosed bullet point divs
        formattedBody = formattedBody.replace(/(<div[^>]*>‚Ä¢ [^<]*?)(?=<p|$)/g, '$1</div>');
        
        // Handle special GSA formatting
        formattedBody = formattedBody
            // Highlight rule references
            .replace(/\b(R\d+|Rule \d+)\b/g, '<span style="background: #eff6ff; color: #1d4ed8; padding: 1px 4px; border-radius: 3px; font-weight: 600;">$1</span>')
            // Highlight compliance terms
            .replace(/\b(compliant|non-compliant|compliance|requirements?)\b/gi, '<span style="font-weight: 600; color: #059669;">$1</span>')
            // Highlight important terms
            .replace(/\b(IMPORTANT|NOTE|ATTENTION|REQUIRED)\b/g, '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 3px; font-weight: 700; font-size: 11px;">$1</span>')
            // Format email addresses
            .replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g, '<a href="mailto:$1" style="color: #2563eb; text-decoration: underline;">$1</a>')
            // Format phone numbers
            .replace(/(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g, '<span style="color: #059669; font-weight: 500;">$1</span>');
        
        formattedEmail += `<div style="margin-top: 15px; line-height: 1.6;">${formattedBody}</div>`;
    }
    
    return formattedEmail;
}

        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab and mark as active
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        }
        
        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ${message}
                </div>
            `;
        }
        
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="result-section">
                    <div class="result-header">‚ùå Error</div>
                    <div class="result-content">${message}</div>
                </div>
            `;
        }
        
        function updateStatus(message) {
            document.getElementById('system-status').textContent = message;
        }
        
        function clearAll() {
            if (confirm('Clear all data and reset interface?')) {
                currentRequestId = null;
                document.getElementById('current-request').textContent = 'None';
                document.getElementById('analyze-btn').disabled = true;
                document.getElementById('results-content').innerHTML = '<div class="loading">No analysis results yet.</div>';
                document.getElementById('debug-results').innerHTML = 'No debug data loaded.';
                document.getElementById('health-results').innerHTML = 'Click "Health Check" to test system status.';
                document.getElementById('service-results').innerHTML = 'Click "Test AI Services" to check availability.';
                document.getElementById('raw-results').innerHTML = 'Raw API responses will appear here.';
                
                // Reset document inputs
                const container = document.getElementById('documents-container');
                container.innerHTML = '';
                addDocument();
                
                updateStatus('Interface reset');
            }
        }
    </script>
</body>
</html>
    
    <!-- return formattedEmail;
}

        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab and mark as active
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        }
        
        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ${message}
                </div>
            `;
        }
        
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="result-section">
                    <div class="result-header">‚ùå Error</div>
                    <div class="result-content">${message}</div>
                </div>
            `;
        }
        
        function updateStatus(message) {
            document.getElementById('system-status').textContent = message;
        }
        
        function clearAll() {
            if (confirm('Clear all data and reset interface?')) {
                currentRequestId = null;
                document.getElementById('current-request').textContent = 'None';
                document.getElementById('analyze-btn').disabled = true;
                document.getElementById('results-content').innerHTML = '<div class="loading">No analysis results yet.</div>';
                document.getElementById('debug-results').innerHTML = 'No debug data loaded.';
                document.getElementById('health-results').innerHTML = 'Click "Health Check" to test system status.';
                document.getElementById('service-results').innerHTML = 'Click "Test AI Services" to check availability.';
                document.getElementById('raw-results').innerHTML = 'Raw API responses will appear here.';
                
                // Reset document inputs
                const container = document.getElementById('documents-container');
                container.innerHTML = '';
                addDocument();
                
                updateStatus('Interface reset');
            }
        }
    </script>
</body>
</html> -->
