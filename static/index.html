<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GSA Document Analyzer - Complete Interface</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f7fa; }
        
        .header { background: #1e40af; color: white; padding: 20px; text-align: center; }
        .header h1 { margin-bottom: 5px; }
        .status-bar { background: #374151; color: #e5e7eb; padding: 10px; font-size: 14px; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .panel h2 { margin-bottom: 15px; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        
        /* Forms */
        select, textarea, input { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin: 5px 0; }
        textarea { height: 80px; font-family: 'Courier New', monospace; resize: vertical; }
        label { display: block; font-weight: 500; margin: 10px 0 5px; color: #374151; }
        
        .doc-input { border: 1px solid #e5e7eb; padding: 15px; margin: 10px 0; border-radius: 6px; background: #f9fafb; }
        .remove-btn { background: #ef4444; color: white; width: auto; padding: 5px 10px; margin-top: 5px; }
        
        /* Results */
        .result-section { margin: 15px 0; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; }
        .result-header { background: #f8fafc; padding: 12px; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        .result-content { padding: 15px; max-height: 400px; overflow-y: auto; }
        
        .status { display: inline-block; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .status.ok { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.unknown { background: #f3f4f6; color: #6b7280; }
        
        .field { display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 8px; background: #f9fafb; margin: 5px 0; border-radius: 4px; }
        .field-label { font-weight: 600; color: #4b5563; }
        
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .spinner { border: 2px solid #f3f4f6; border-top: 2px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .code { background: #f1f5f9; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; white-space: pre-wrap; }
        
        /* Enhanced text content formatting */
        .text-content { 
            background: #f8fafc; 
            padding: 20px; 
            border-radius: 8px; 
            line-height: 1.7; 
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        
        .email-content {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .email-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .brief-content {
            background: #fefefe;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            font-family: Georgia, serif;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 15px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #3b82f6; background: #eff6ff; }
        
        .full-width { grid-column: 1 / -1; }
        
        /* Redacted data styling */
        .redacted-section { background: #fef3c7; padding: 10px; border-radius: 4px; margin: 5px 0; border-left: 3px solid #f59e0b; }
        .pii-hash { font-family: monospace; color: #6b7280; font-size: 11px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è GSA Document Analyzer</h1>
        <p>Complete Backend Interface - All Endpoints</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        System Status: <span id="system-status">Unknown</span> | Request ID: <span id="current-request">None</span>
    </div>
    
    <div class="container">
        <!-- Main Controls -->
        <div class="controls">
            <button class="btn btn-success" onclick="checkHealth()">üè• Health Check</button>
            <button class="btn btn-warning" onclick="testServices()">üß™ Test AI Services</button>
            <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>
        
        <div class="grid">
            <!-- Document Input Panel -->
            <div class="panel">
                <h2>üì• Document Input</h2>
                
                <label>Quick Samples:</label>
                <select id="sample-select" onchange="loadSample()">
                    <option value="">-- Load Sample --</option>
                    <option value="complete">‚úÖ Complete Vendor</option>
                    <option value="incomplete">‚ùå Incomplete Vendor</option>
                    <option value="custom">‚úèÔ∏è Custom Data</option>
                </select>
                
                <div id="documents-container">
                    <!-- Dynamic document inputs will be added here -->
                </div>
                
                <div style="margin: 15px 0;">
                    <button class="btn btn-success" onclick="addDocument()" style="width: auto;">+ Add Document</button>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="ingestDocuments()" id="ingest-btn">üì§ Ingest Documents</button>
                    <button class="btn btn-secondary" onclick="analyzeDocuments()" id="analyze-btn" disabled>üîç Analyze</button>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="panel">
                <h2>üìä Analysis Results</h2>
                <div id="results-content">
                    <div class="loading">No analysis results yet. Ingest documents first.</div>
                </div>
            </div>
            
            <!-- Debug Panel -->
            <div class="panel full-width">
                <h2>üõ†Ô∏è System Debug & Testing</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="showTab('debug-data')">Debug Data</div>
                    <div class="tab" onclick="showTab('health-info')">Health Info</div>
                    <div class="tab" onclick="showTab('service-test')">Service Tests</div>
                    <div class="tab" onclick="showTab('raw-response')">Raw Response</div>
                </div>
                
                <div id="debug-data" class="tab-content">
                    <div class="controls">
                        <input type="text" id="debug-request-id" placeholder="Request ID (leave empty for current)">
                        <button class="btn btn-warning" onclick="debugRequest()">üêõ Debug Request</button>
                    </div>
                    <div id="debug-results">No debug data loaded.</div>
                </div>
                
                <div id="health-info" class="tab-content" style="display: none;">
                    <div id="health-results">Click "Health Check" to test system status.</div>
                </div>
                
                <div id="service-test" class="tab-content" style="display: none;">
                    <div id="service-results">Click "Test AI Services" to check RAG and LLM availability.</div>
                </div>
                
                <div id="raw-response" class="tab-content" style="display: none;">
                    <div id="raw-results">Raw API responses will appear here after operations.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRequestId = null;
        let lastRawResponse = null;
        
        // Sample data
        const samples = {
            complete: [
                {
                    name: "company_profile",
                    type: "profile", 
                    text: "TechCorp LLC UEI: ABC123DEF456 DUNS: 123456789 NAICS: 541511 POC: John Smith, john@techcorp.com, (555) 123-4567 Address: 123 Main St, Washington DC 20500 SAM.gov: registered"
                },
                {
                    name: "past_performance",
                    type: "past_performance",
                    text: "Customer: Department of Defense Contract: Software development Value: $150,000 Period: 01/2023 - 12/2023 Contact: procurement@dod.mil"
                },
                {
                    name: "pricing_sheet", 
                    type: "pricing",
                    text: "Senior Developer, 185, Hour\nSystems Architect, 225, Hour\nProject Manager, 175, Hour"
                }
            ],
            incomplete: [
                {
                    name: "broken_company",
                    type: "profile",
                    text: "Incomplete Corp Contact: jane@incomplete.com"
                }
            ],
            custom: [
                {
                    name: "custom_doc",
                    type: "",
                    text: "Enter your custom document content here..."
                }
            ]
        };
        
        // Initialize with one document input
        document.addEventListener('DOMContentLoaded', function() {
            addDocument();
            updateStatus('Ready');
        });
        
        function loadSample() {
            const selected = document.getElementById('sample-select').value;
            if (!selected) return;
            
            const container = document.getElementById('documents-container');
            container.innerHTML = '';
            
            samples[selected].forEach(doc => {
                addDocument();
                const lastInput = container.lastElementChild;
                lastInput.querySelector('.doc-name').value = doc.name;
                lastInput.querySelector('.doc-type').value = doc.type;
                lastInput.querySelector('.doc-text').value = doc.text;
            });
        }
        
        function addDocument() {
            const container = document.getElementById('documents-container');
            const index = container.children.length + 1;
            
            const docDiv = document.createElement('div');
            docDiv.className = 'doc-input';
            docDiv.innerHTML = `
                <label>Document Name:</label>
                <input type="text" class="doc-name" placeholder="document_${index}" value="document_${index}">
                
                <label>Type Hint:</label>
                <select class="doc-type">
                    <option value="">Auto-detect</option>
                    <option value="profile">Company Profile</option>
                    <option value="past_performance">Past Performance</option>
                    <option value="pricing">Pricing Sheet</option>
                </select>
                
                <label>Document Text:</label>
                <textarea class="doc-text" placeholder="Paste document content here..."></textarea>
                
                <button class="remove-btn" onclick="removeDocument(this)">Remove</button>
            `;
            container.appendChild(docDiv);
        }
        
        function removeDocument(btn) {
            btn.parentElement.remove();
        }
        
        async function ingestDocuments() {
            const documents = [];
            const docInputs = document.querySelectorAll('.doc-input');
            
            docInputs.forEach(input => {
                const name = input.querySelector('.doc-name').value.trim();
                const type = input.querySelector('.doc-type').value;
                const text = input.querySelector('.doc-text').value.trim();
                
                if (text) {
                    documents.push({
                        name: name || `document_${documents.length + 1}`,
                        type_hint: type || null,
                        text: text
                    });
                }
            });
            
            if (documents.length === 0) {
                alert('Please add at least one document with content.');
                return;
            }
            
            updateStatus('Ingesting documents...');
            showLoading('results-content', 'Processing documents...');
            
            try {
                const response = await fetch('/api/ingest_v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documents })
                });
                
                const result = await response.json();
                lastRawResponse = result;
                
                if (result.request_id) {
                    currentRequestId = result.request_id;
                    document.getElementById('current-request').textContent = currentRequestId;
                    document.getElementById('analyze-btn').disabled = false;
                    
                    showIngestResults(result);
                    updateStatus('Documents ingested - Ready for analysis');
                } else {
                    throw new Error('No request ID received');
                }
                
            } catch (error) {
                showError('results-content', `Ingestion failed: ${error.message}`);
                updateStatus('Ingestion failed');
            }
        }
        
        async function analyzeDocuments() {
            if (!currentRequestId) {
                alert('Please ingest documents first.');
                return;
            }
            
            updateStatus('Running AI analysis...');
            showLoading('results-content', 'Analyzing compliance...');
            
            try {
                const response = await fetch(`/api/analyze?request_id=${currentRequestId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                lastRawResponse = result;
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                showAnalysisResults(result);
                updateStatus('Analysis complete');
                
            } catch (error) {
                showError('results-content', `Analysis failed: ${error.message}`);
                updateStatus('Analysis failed');
            }
        }
        
        async function checkHealth() {
            updateStatus('Checking system health...');
            
            try {
                const response = await fetch('/api/healthz');
                const result = await response.json();
                
                const healthDiv = document.getElementById('health-results');
                healthDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">üè• System Health Check</div>
                        <div class="result-content">
                            <div class="field">
                                <div class="field-label">Status:</div>
                                <div><span class="status ${result.ok ? 'ok' : 'error'}">${result.ok ? 'HEALTHY' : 'UNHEALTHY'}</span></div>
                            </div>
                            <div class="field">
                                <div class="field-label">Response:</div>
                                <div>${JSON.stringify(result)}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">Timestamp:</div>
                                <div>${new Date().toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                updateStatus(result.ok ? 'System healthy' : 'System unhealthy');
                
            } catch (error) {
                const healthDiv = document.getElementById('health-results');
                healthDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">‚ùå Health Check Failed</div>
                        <div class="result-content">
                            <span class="status error">UNHEALTHY</span>
                            <p>Error: ${error.message}</p>
                        </div>
                    </div>
                `;
                updateStatus('System unhealthy');
            }
        }
        
        async function testServices() {
            updateStatus('Testing AI services...');
            
            try {
                const response = await fetch('/api/test-services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                const serviceDiv = document.getElementById('service-results');
                serviceDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">üß™ AI Services Test Results</div>
                        <div class="result-content">
                            <div class="field">
                                <div class="field-label">RAG Service:</div>
                                <div><span class="status ${result.rag === 'available' ? 'ok' : 'error'}">${result.rag || 'Unknown'}</span></div>
                            </div>
                            <div class="field">
                                <div class="field-label">LLM Service:</div>
                                <div><span class="status ${result.llm === 'available' ? 'ok' : 'error'}">${result.llm || 'Unknown'}</span></div>
                            </div>
                            ${result.llm_connection ? `
                                <div class="field">
                                    <div class="field-label">LLM Connection:</div>
                                    <div><span class="status ${result.llm_connection.status === 'success' ? 'ok' : 'error'}">${result.llm_connection.status}</span></div>
                                </div>
                            ` : ''}
                            <div class="code">${JSON.stringify(result, null, 2)}</div>
                        </div>
                    </div>
                `;
                
                updateStatus('Service test complete');
                
            } catch (error) {
                showError('service-results', `Service test failed: ${error.message}`);
                updateStatus('Service test failed');
            }
        }
        
        async function debugRequest() {
            const requestId = document.getElementById('debug-request-id').value.trim() || currentRequestId;
            
            if (!requestId) {
                alert('Please provide a request ID or ingest documents first.');
                return;
            }
            
            updateStatus('Loading debug data...');
            
            try {
                const response = await fetch(`/api/debug/${requestId}`);
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const debugDiv = document.getElementById('debug-results');
                debugDiv.innerHTML = `
                    <div class="result-section">
                        <div class="result-header">üêõ Debug Data for ${requestId}</div>
                        <div class="result-content">
                            ${renderRedactedData(result.redacted_docs)}
                            <details style="margin-top: 15px;">
                                <summary>Raw Parsed Data</summary>
                                <div class="code">${JSON.stringify(result.parsed_data, null, 2)}</div>
                            </details>
                        </div>
                    </div>
                `;
                
                updateStatus('Debug data loaded');
                
            } catch (error) {
                showError('debug-results', `Debug failed: ${error.message}`);
                updateStatus('Debug failed');
            }
        }
        
        function renderRedactedData(redacted_docs) {
            let html = '<h4>Redacted Documents:</h4>';
            
            if (redacted_docs.company) {
                html += `
                    <div class="redacted-section">
                        <strong>Company Profile (Redacted)</strong><br>
                        <div>${redacted_docs.company.redacted_text || 'No redacted text'}</div>
                        <div class="pii-hash">PII Hashes: ${Object.keys(redacted_docs.company.pii_hashes || {}).length} items</div>
                    </div>
                `;
            }
            
            if (redacted_docs.past_performance && redacted_docs.past_performance.length > 0) {
                html += '<h5>Past Performance (Redacted):</h5>';
                redacted_docs.past_performance.forEach((pp, i) => {
                    html += `
                        <div class="redacted-section">
                            <strong>Contract ${i + 1}</strong><br>
                            <div>${pp.redacted_text || 'No redacted text'}</div>
                            <div class="pii-hash">PII Hashes: ${Object.keys(pp.pii_hashes || {}).length} items</div>
                        </div>
                    `;
                });
            }
            
            if (redacted_docs.pricing) {
                html += `
                    <div class="redacted-section">
                        <strong>Pricing (Not Redacted)</strong><br>
                        <div class="code">${JSON.stringify(redacted_docs.pricing, null, 2)}</div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function showIngestResults(result) {
            const html = `
                <div class="result-section">
                    <div class="result-header">‚úÖ Documents Ingested</div>
                    <div class="result-content">
                        <div class="field">
                            <div class="field-label">Request ID:</div>
                            <div>${result.request_id}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Documents Processed:</div>
                            <div>${result.doc_summaries?.length || 0}</div>
                        </div>
                        
                        ${result.doc_summaries ? `
                            <h4>Document Summary:</h4>
                            ${result.doc_summaries.map(doc => `
                                <div class="field">
                                    <div class="field-label">${doc.name}:</div>
                                    <div>${doc.type} (${doc.redacted ? 'PII Redacted' : 'Not Redacted'})</div>
                                </div>
                            `).join('')}
                        ` : ''}
                        
                        <div style="color: #10b981; margin-top: 15px; font-weight: 600;">
                            ‚úÖ Ready for analysis! Click "Analyze" button.
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('results-content').innerHTML = html;
        }
        
        function showAnalysisResults(result) {
            const checklist = result.checklist || {};
            const parsed = result.parsed || {}; // This will contain redacted data
            
            let html = `
                <div class="result-section">
                    <div class="result-header">üéØ Compliance Status</div>
                    <div class="result-content">
                        <span class="status ${checklist.required_ok ? 'ok' : 'error'}">
                            ${checklist.required_ok ? '‚úÖ COMPLIANT' : '‚ùå NON-COMPLIANT'}
                        </span>
                        ${checklist.compliance_summary ? `<p style="margin-top: 10px;">${checklist.compliance_summary}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Issues Section
            if (checklist.problems && checklist.problems.length > 0) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üö® Issues Found</div>
                        <div class="result-content">
                            ${checklist.problems.map(problem => `
                                <div style="background: #fef2f2; border-left: 4px solid #f87171; padding: 12px; margin: 10px 0; border-radius: 4px;">
                                    <strong>${(problem.issue || 'Issue').replace(/_/g, ' ').toUpperCase()}</strong>
                                    ${problem.rule_id ? `<span style="background: #1d4ed8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 10px;">${problem.rule_id}</span>` : ''}
                                    <br><br>
                                    <span style="color: #6b7280;">Evidence:</span> ${problem.evidence || problem.description || 'No details available'}
                                    ${problem.severity ? `<br><span style="color: #6b7280;">Severity:</span> <span style="color: ${problem.severity === 'blocking' ? '#dc2626' : problem.severity === 'critical' ? '#ea580c' : '#65a30d'}; font-weight: 600;">${problem.severity.toUpperCase()}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Parsed/Redacted Data Section
            html += `
                <div class="result-section">
                    <div class="result-header">üìã Processed Data (PII Redacted)</div>
                    <div class="result-content">
                        ${renderParsedRedactedData(parsed)}
                    </div>
                </div>
            `;
            
            // Strategic Brief Section with enhanced formatting
            if (result.brief) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìù Strategic Negotiation Brief</div>
                        <div class="result-content">
                            <div class="brief-content">${formatBriefContent(result.brief)}</div>
                        </div>
                    </div>
                `;
            }
            
            // Client Email Section with enhanced formatting
            if (result.client_email) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìß Client Communication</div>
                        <div class="result-content">
                            <div class="email-content">${formatEmailContent(result.client_email)}</div>
                        </div>
                    </div>
                `;
            }
            
            // Citations Section
            if (checklist.citations && checklist.citations.length > 0) {
                html += `
                    <div class="result-section">
                        <div class="result-header">üìö Rule Citations</div>
                        <div class="result-content">
                            ${checklist.citations.map(citation => `
                                <div style="background: #eff6ff; padding: 12px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #3b82f6;">
                                    <strong style="color: #1d4ed8;">${citation.rule_id}:</strong><br>
                                    <span style="color: #4b5563;">${citation.chunk || citation.content || 'No content available'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Metadata Section
            html += `
                <div class="result-section">
                    <div class="result-header">‚ÑπÔ∏è Analysis Metadata</div>
                    <div class="result-content">
                        <div class="field">
                            <div class="field-label">Request ID:</div>
                            <div>${result.request_id || 'Unknown'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Powered By:</div>
                            <div>${result.powered_by || 'Unknown'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Citations:</div>
                            <div>${checklist.citations ? checklist.citations.length : 0} rules referenced</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = html;
            
            // Update raw response tab
            document.getElementById('raw-results').innerHTML = `
                <div class="result-section">
                    <div class="result-header">üìã Latest API Response</div>
                    <div class="result-content">
                        <div class="code">${JSON.stringify(result, null, 2)}</div>
                    </div>
                </div>
            `;
        }
        
        function renderParsedRedactedData(parsed) {
            if (!parsed || Object.keys(parsed).length === 0) {
                return '<p style="color: #6b7280;">No parsed data available</p>';
            }
            
            let html = '';
            
            // Company data (redacted)
            if (parsed.company) {
                html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üè¢ Company Information (Redacted)</h4>';
                html += '<div class="redacted-section">';
                if (parsed.company.redacted_text) {
                    html += `<div><strong>Redacted Text:</strong><br>${parsed.company.redacted_text}</div>`;
                }
                if (parsed.company.pii_hashes) {
                    html += `<div class="pii-hash"><strong>PII Hashes:</strong> ${Object.keys(parsed.company.pii_hashes).length} items protected</div>`;
                }
                html += '</div>';
            }
            
            // Past Performance data (redacted)
            if (parsed.past_performance && parsed.past_performance.length > 0) {
                html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üìà Past Performance (Redacted)</h4>';
                parsed.past_performance.forEach((pp, i) => {
                    html += '<div class="redacted-section">';
                    html += `<strong>Contract ${i + 1}:</strong><br>`;
                    if (pp.redacted_text) {
                        html += `<div>${pp.redacted_text}</div>`;
                    }
                    if (pp.pii_hashes) {
                        html += `<div class="pii-hash">PII Hashes: ${Object.keys(pp.pii_hashes).length} items</div>`;
                    }
                    html += '</div>';
                });
            }
            
            // Pricing data (not redacted)
            if (parsed.pricing) {
                html += '<h4 style="color: #1f2937; margin-bottom: 10px;">üí∞ Pricing Information</h4>';
                html += `<div class="code">${JSON.stringify(parsed.pricing, null, 2)}</div>`;
            }
            
            return html || '<p style="color: #6b7280;">No processed data found</p>';
        }
        
        function formatBriefContent(brief) {
            if (!brief) return 'No brief available';
            
            // Format the brief with better paragraph breaks and emphasis
            return brief
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold markdown
                .replace(/\n\n/g, '</p><p>') // Paragraph breaks
                .replace(/\n/g, '<br>') // Line breaks
                .replace(/^/, '<p>') // Start paragraph
                .replace(/$/, '</p>'); // End paragraph
        }
        
        function formatEmailContent(email) {
            if (!email) return 'No email available';
            
            // Split into subject and body
            const lines = email.split('\n');
            let subject = '';
            let body = '';
            let isBody = false;
            
            for (const line of lines) {
                if (line.toLowerCase().startsWith('subject:')) {
                    subject = line;
                } else if (line.trim() === '' && subject) {
                    isBody = true;
                } else if (isBody) {
                    body += line + '\n';
                } else if (!subject) {
                    body += line + '\n';
                }
            }
            
            let formattedEmail = '';
            
            if (subject) {
                formattedEmail += `<div class="email-header">${subject}</div>`;
            }
            
            formattedEmail += `<div style="white-space: pre-line; line-height: 1.6;">${body.trim()}</div>`;
            
            return formattedEmail;
        }
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab and mark as active
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        }
        
        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ${message}
                </div>
            `;
        }
        
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="result-section">
                    <div class="result-header">‚ùå Error</div>
                    <div class="result-content">${message}</div>
                </div>
            `;
        }
        
        function updateStatus(message) {
            document.getElementById('system-status').textContent = message;
        }
        
        function clearAll() {
            if (confirm('Clear all data and reset interface?')) {
                currentRequestId = null;
                document.getElementById('current-request').textContent = 'None';
                document.getElementById('analyze-btn').disabled = true;
                document.getElementById('results-content').innerHTML = '<div class="loading">No analysis results yet.</div>';
                document.getElementById('debug-results').innerHTML = 'No debug data loaded.';
                document.getElementById('health-results').innerHTML = 'Click "Health Check" to test system status.';
                document.getElementById('service-results').innerHTML = 'Click "Test AI Services" to check availability.';
                document.getElementById('raw-results').innerHTML = 'Raw API responses will appear here.';
                
                // Reset document inputs
                const container = document.getElementById('documents-container');
                container.innerHTML = '';
                addDocument();
                
                updateStatus('Interface reset');
            }
        }
    </script>
</body>
</html>
